
Данный проект представляет собой распределительную систему с механизмом межшардовых транзакций, состояющу из сервиса оркестратора и сервисов [шардов](https://github.com/Igor-makeev/mibshard). 

Схема системы:

![Screenshot from 2023-02-17 20-49-45](https://user-images.githubusercontent.com/67610606/219625570-03023fd9-a235-49a7-be25-5dfbedbd4844.png)


# miborchestrator

Сервис оркестратор распределяет транзакции между [шардами](https://github.com/Igor-makeev/mibshard).

Сводное HTTP API
----------------

Оркестратор должен представлять следующие HTTP-хендлеры:

- `POST /auth/register` — регистрация пользователя;
- `POST /auth/login` — аутентификация пользователя;
- `POST /api/user/create_wallet` — создание пользователем кошелька;
- `POST /api/user/do_transaction` — перевод на средств на кошелек другого пользователя;
- `GET /api/user/transactions/:id` — получение списка осуществленных пользователем транзакций и их статусов по id кошелька;
- `GET /api/user/balance/:id` — получение текущего баланса кошелька пользователя;


### Регистрация пользователя

Хендлер: `POST  /auth/register`

Регистрация производится по паре логин/пароль. Каждый логин должен быть уникальным.

После успешной регистрации должна происходить автоматическая аутентификация пользователя.

Формат запроса:

    Content-Type: application/json
    ...

    {
    
    "login": "<login>",
    
    "password": "<password>"
    
    }
    
Возможные коды ответа:

- `200` — пользователь успешно зарегистрирован и аутентифицирован;
- `400` — неверный формат запроса;
- `409` — логин уже занят;
- `500` — внутренняя ошибка сервера


### Аутентификация пользователя

Хендлер: `POST /auth/login`

Аутентификация производится по паре логин/пароль.

Формат запроса:

    Content-Type: application/json
    ...

    {
    
    "login": "<login>",
    
    "password": "<password>"
    
    }
    
Возможные коды ответа:

- `200` — пользователь успешно аутентифицирован;
- `400` — неверный формат запроса;
- `401` — неверная пара логин/пароль;
- `500` — внутренняя ошибка сервера.

### Создание кошелька

Хендлер: `POST /api/user/createwallet.`

Хендлер доступен только аутентифицированным пользователям. ID кошелька является последовательность цифр произвольной длины.
Номер [шарда](https://github.com/Igor-makeev/mibshard) на который будет респределён вычисляется по формуле: `id%N` - где N является кличеством [шардов](https://github.com/Igor-makeev/mibshard).

Формат запроса:

    Content-Type: application/json
    ...

    {
    
    "wallet_id": "<id>",
    
    }
    
Возможные коды ответа:

- `202` — запрос на создание кошелька принят в обработку;
- `400` — неверный формат запроса;
- `401` — пользователь не аутентифицирован;
- `500` — внутренняя ошибка сервера.

### Перевод средств на счёт кошелька другого пользователя

Хендлер: `POST /api/user/do_transacton.`

Хендлер доступен только аутентифицированным пользователям. Номер [шарда](https://github.com/Igor-makeev/mibshard) на который будет респределён вычисляется по формуле: `id%N` - где N является кличеством [шардов](https://github.com/Igor-makeev/mibshard). В случае неудачной транзакции ей будет присвоен статус `FAILED` с указанием причины в журнале транзакций.

Схема транзакции:

![Screenshot from 2023-02-17 23-05-03](https://user-images.githubusercontent.com/67610606/219660839-174e5d15-fe0d-4d42-8caa-762802d3beb7.png)

Формат запроса:

    Content-Type: application/json
    ...

    {
    
    "from_id": "<id>",
    
    "to_id": "<id>",
    
    "amount": "<amount>"
    
    }
    
Возможные коды ответа:

- `202` — запрос на принят в обработку;
- `400` — неверный формат запроса;
- `401` — пользователь не аутентифицирован;
- `500` — внутренняя ошибка сервера.

###  Получение списка осуществленных пользователем транзакций и их статусов по ID кошелька

Хендлер: `GET /api/user/transactions/:id`

Хендлер доступен только авторизованному пользователю. Номера транзакций должны быть отсортированы по времени инициации от самых старых к самым новым. Формат даты — RFC3339.

Доступные статусы транзакций:

- `PENDING` — транзакция инициирована, но не попала в обработку;
- `PROCESSING` — транзакция в обработке;
- `INVALID` — невозможная транзакция;
- `FAILED` — транзакция не состоялась;
- `SUCCESSFUL` — транзакция прошла успешно.

    
Возможные коды ответа:

- `200` — успешная обработка запроса.

Формат ответа:
 
    Content-Type: application/json
    ...
    [
      {
          "wallet_id": "12312312",
          "TxID": "9278923470",
          "ammount":"+50"
          "status": "PROCESSED",
          "note": "transaction in processing",
          "initiated_at": "2020-12-10T15:15:45+03:00"
      },
      {
          "wallet_id": "12312312",
          "TxID": "124125125",
          "ammount":"+50"
          "status": "FAILED",
          "note": "transaction confirmation limit exceeded",
          "initiated_at": "2020-12-10T15:12:01+03:00"
      },
      {
          "wallet_id": "12312312",
          "TxID": "346436439",
          "status": "INVALID",
          "ammount":"+50"
          "note": "not enough funds in the wallet",
          "initiated_at": "2020-12-09T16:09:53+03:00"
      }
     ]
   
- `204` — нет данных для ответа.
- `401` — пользователь не аутентифицирован;
- `500` — внутренняя ошибка сервера.

###  Получение баланса кошелька по его ID

Хендлер: `GET /api/user/balance/:id`

Хендлер доступен только авторизованному пользователю. В ответе должны содержаться данные о текущем балансе кошелька. 

Возможные коды ответа:

- `200` — успешная обработка запроса.

      Content-Type: application/json
      ...
    
      {
          "TxID": "9278923470",
          "status": "PROCESSED",
          "note": "transaction in processing",
          "initiated_at": "2020-12-10T15:15:45+03:00"
      }
      


- `401` — пользователь не аутентифицирован;
- `500` — внутренняя ошибка сервера.


Конфигурирование сервиса оркестратора
--------------------------------------------

Сервис должен поддерживать конфигурирование следующими методами:

адрес и порт запуска сервиса: переменная окружения ОС `RUN_ADDRESS` или флаг -a;

адрес подключения к базе данных: переменная окружения ОС `DATABASE_URI` или флаг -d;

адреса [шардов](https://github.com/Igor-makeev/mibshard): переменные окружения ОС `SHARD_ADDRESS_N` (Где N - номер [шарда](https://github.com/Igor-makeev/mibshard)).
